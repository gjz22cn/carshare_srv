<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<link rel="stylesheet" href="css/all.css" />
		<link rel="stylesheet" href="css/public.css" />
		<link rel="stylesheet" href="css/router_currentsource.css" />
		<script type="text/javascript" src="js/jquery.1.9.1.js"></script>
		<script type="text/javascript" src="js/vue.js"></script>
		<title id="name" fileNam="plugin">账单明细</title>
	</head>

	<body onload="load()">
		<div id="vueApp">
			<!--记录数据-->
			<div id="fileName" fileNam="router_historyresource" isroot="root"></div>
			<!--记录数据-->
			<div id="pluginContainer" fileNam="plugin" isroot="root">
				<div class="pluginTitle">
					<!-- <a class="backBtn" >返回</a> -->筛选</div>

				<div>
					<table style="margin-left:40px;margin-top:20px;margin-bottom:20px;">
						<tr>
							<td style="width:80px">厂商名:</td>
							<td style="width:300px"><select class="paystyle" name="csname" id="csname"><option selected="selected" value=""></option></select></td>
							<td style="width:80px">小区名:</td>
							<td style="width:300px"><select class="paystyle" name="xqname" id="xqname"><option selected="selected" value=""></option></select></td>
						</tr>
						<tr>
							<td>车牌:</td>
							<td><input id="chepai"  type="text" style="width:128px;" name="chepai"></input></td>
                            <td></td>
                            <td></td>
						</tr>
						<tr>
							<td><button class="redBtn" v-on:click="refresh"  style="background: orange;">筛选</button></td>
                            <td></td>
                            <td></td>
                            <td></td>
						</tr>
					</table>
				</div>
				<div style="height: 20px;background: rgba(0,0,0,0.05);"></div>

                <div class="pluginTitle">账单明细</div>
				<div class="tableContainer" >
					<table id="table" style="margin-top: 10px;">
						<tr>
							<th>车牌</th>
							<th>小区</th>
							<th>进场时间</th>
                            <th>出场时间</th>
							<th>停车费(元)</th>
						</tr>
						<tr id="cell" class="cell" v-for="dic in message">
							<td>{{dic.chepai}}</td>
							<td>{{dic.xqname}}</td>
							<td>{{dic.in_time}}</td>
							<td>{{dic.out_time}}</td>
							<td>{{dic.amount}}</td>
						</tr>

					</table>
				</div>
				<div style="height: 15px;"></div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="js/public.js"></script>
	<script>
        var userInfo = JSON.parse(window.localStorage.getItem('userInfo'));
		var vm = new Vue({
			el: '#vueApp',
			data: {
                message: []
			},
			methods: {
				refresh:function(){
                    var _self = this;
					var csname = $("#csname").val();
					var xqname = $("#xqname").val();
					var chepai = $("#chepai").val();
                    _self.reload(csname, xqname, chepai);
				},
                reload: function(csname, xqname, chepai) {
                    var filter = {};

                    if (userInfo.role == "changshang") {
                        filter.pps_id = userInfo.roleId;
                    } else if (userInfo.role == "xiaoqu") {
                        filter.xq_id = userInfo.roleId;
                    }

                    if (csname != "") {
                        filter.pps_id = csname;
                    }
                    if (xqname != "") {
                        filter.community_id = xqname;
                    }
                    if (chepai != "") {
                        filter.chepai = chepai;
                    }

                    priAjaxGet("/parking/bill?filter="+encodeURI(JSON.stringify(filter)), "",
                            function(data) {
                                if (data.ret == 0) {
                                    vm.message = data.data;
                                } else {
                                    alert(data.msg);
                                }
                            },
                            function() {
                                alert("获取账单明细失败！");
                            });                    
                }
			}

		});

        function getPpsNameList() {
            priAjaxGet("/pps/namelist", "",
                    function(data) {
                        if (data.ret == 0) {
                            for(var idx in data.data) {
                                $("#csname").append("<option value='"+data.data[idx].id+"'>"+data.data[idx].name+"</option>");
                            }
                        } else {
                            //alert(data.msg);
                        }
                    },
                    function() {
                        //alert("获取账单明细失败！");
                    });                    
        }

        function getXiaoquNameList(ppsId) {
            var filterStr = "";
            if (ppsId != "") {
                filterStr = "filter="+JSON.stringify({pps_id: ppsId});
            }

            priAjaxGet("/xiaoqu/namelist", filterStr,
                    function(data) {
                        if (data.ret == 0) {
                            $("#xqname").empty();
                            $("#xqname").append('<option selected="selected" value=""></option>');
                            for(var idx in data.data) {
                                $("#xqname").append("<option value='"+data.data[idx].id+"'>"+data.data[idx].name+"</option>");
                            }
                        } else {
                            //alert(data.msg);
                        }
                    },
                    function() {
                        //alert("获取账单明细失败！");
                    });                    
        }

        $("#csname").change(function(){
            getXiaoquNameList($("#csname").val());
        });

        function load() {
            vm.reload("", "", "");
            getPpsNameList();
            getXiaoquNameList();
        }
	</script>

</html>
